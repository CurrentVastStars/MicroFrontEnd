    node('master') {

         stage('Prepare') {
            echo "1.Prepare Stage"
            checkout scm
			docker_host = "harbor.irobotbox.com"
			img_name = "irobotbox/whalesystem-webui"
            script {
                build_tag = "staging-v1.${env.BUILD_NUMBER}" //sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                if (env.SVN_REVISION != 'master' && env.SVN_REVISION != null) {
                    build_tag = "{build_tag}.${env.SVN_REVISION}"
                }
                echo build_tag
            }
        }
		
        stage('Build') {
            echo "2.Build Docker Image Stage"
            sh "docker build -f Dockerfile -t ${docker_host}/${img_name}:${build_tag} ."
        }

        stage('Push') {
            echo "3.Push Docker Image To Local Harbor"
            withCredentials([usernamePassword(credentialsId: 'docker-register-harbor', passwordVariable: 'dockerPassword', usernameVariable: 'dockerUser')]) {
                sh "echo '${dockerPassword}' | docker login  -u ${dockerUser} --password-stdin ${docker_host}"
				
				sh "docker push ${docker_host}/${img_name}:${build_tag}"
                sh "docker tag ${docker_host}/${img_name}:${build_tag} ${docker_host}/${img_name}:latest"
				sh "docker push ${docker_host}/${img_name}:latest"
                sh "docker rmi ${docker_host}/${img_name}:latest"
            }
        }

        stage('Deploy') {
            //unstash 'complete-build'
            echo "4. Deploy Stage Local K8s"
            sh "sed -i 's/latest/${build_tag}/g' ./deploy/k8s-staging.yaml"
            sh "kubectl --kubeconfig=../../.kube/local-config apply -f ./deploy/k8s-staging.yaml --record"
        }
    }
   